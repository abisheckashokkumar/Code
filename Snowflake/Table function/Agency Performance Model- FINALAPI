Datasource
====================
https://www.kaggle.com/datasets/moneystore/agencyperformance?resource=download


Syntax/code
====================
CREATE OR REPLACE FUNCTION DEV_DB.TEST_SCHEMA.INSURANCE_TBL_FUNCTION 
(IN_PROD_LINE STRING,IN_PROD_DESC STRING,IN_STATE STRING,IN_VENDOR STRING,IN_MAX_AGE STRING,IN_MIN_AGE STRING)
RETURNS TABLE ("AGENCYID" STRING, "PRODUCT_DESCRIPTION" STRING, "PRODUCT_LINE" STRING, "STATE" STRING, "STAT PROFILE YEAR" STRING, "MONTH" STRING, "RETENTION POLICY QTY" STRING, "POLICY INFORCE QTY" STRING, "WRITTEN PREMIUM" STRING, "PRODUCT LOSS AMOUNT" STRING, "RETENTION RATIO" STRING, "LOSS RATIO" STRING, "LOSS RATIO IN 3YR" STRING, "GROWTH RATE IN 3YR" STRING, "AGENCY APPOINTMENT YEAR" STRING, "ACTIVE PRODUCERS" STRING, "MAXIMUM_AGE" STRING, "MINIMUM_AGE" STRING, "VENDOR" STRING)
LANGUAGE SQL
AS 
'
WITH MAIN AS
(
SELECT
AGENCY_ID "AGENCYID",
PROD_ABBR "PRODUCT DESCRIPTION",
PROD_LINE "PRODUCT LINE",
STATE_ABBR "STATE",
STAT_PROFILE_DATE_YEAR "STAT PROFILE YEAR",
MONTHS "MONTH",
RETENTION_POLY_QTY "RETENTION POLICY QTY",
POLY_INFORCE_QTY "POLICY INFORCE QTY",
WRTN_PREM_AMT "WRITTEN PREMIUM",
PRD_INCRD_LOSSES_AMT "PRODUCT LOSS AMOUNT",
RETENTION_RATIO "RETENTION RATIO",
LOSS_RATIO "LOSS RATIO",
LOSS_RATIO_3YR "LOSS RATIO IN 3YR",
GROWTH_RATE_3YR "GROWTH RATE IN 3YR",
AGENCY_APPOINTMENT_YEAR "AGENCY APPOINTMENT YEAR",
ACTIVE_PRODUCERS "ACTIVE PRODUCERS",
MAX_AGE "MAXIMUM AGE",
MIN_AGE "MINIMUM AGE",
VENDOR "VENDOR"
FROM DEV_DB.TEST_SCHEMA.INSURANCE WHERE PRIMARY_AGENCY_ID IS NOT NULL AND RETENTION_RATIO IS NOT NULL
AND GROWTH_RATE_3YR IS NOT NULL
)
SELECT * FROM MAIN R
WHERE (IFNULL(IN_PROD_LINE,'''')='''' OR REGEXP_INSTR(R."PRODUCT LINE",IN_PROD_LINE,1,1,0,''i'')>0)
AND (IFNULL(IN_PROD_DESC,'''')='''' OR REGEXP_INSTR(R."PRODUCT DESCRIPTION",IN_PROD_DESC,1,1,0,''i'')>0)
AND (IFNULL(IN_STATE,'''')='''' OR REGEXP_INSTR(R.STATE,IN_STATE,1,1,0,''i'')>0)
AND (IFNULL(IN_VENDOR,'''')='''' OR REGEXP_INSTR(TRIM(R.VENDOR),IN_VENDOR,1,1,0,''i'')>0)
AND (IFNULL(IN_MAX_AGE,'''')='''' OR REGEXP_INSTR(R."MAXIMUM AGE",IN_MAX_AGE,1,1,0,''i'')>0)
AND (IFNULL(IN_MIN_AGE,'''')='''' OR REGEXP_INSTR(R."MINIMUM AGE",IN_MIN_AGE,1,1,0,''i'')>0)
';




TABLE FUNTION CALL
====================
SELECT * FROM TABLE (DEV_DB.TEST_SCHEMA.INSURANCE_TBL_FUNCTION ('PL','HOMEOWNERS','','E','70','33'));

